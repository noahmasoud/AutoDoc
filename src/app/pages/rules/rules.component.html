<div class="rules-page">
  <div class="page-header">
    <h1>Rules Management</h1>
    <button *ngIf="!editingRule" (click)="startCreate()" class="btn-primary">Create New Rule</button>
  </div>

  <!-- Rule Form -->
  <div *ngIf="editingRule !== null || isCreating" class="rule-form-card">
    <h2>{{ editingRule ? 'Edit Rule' : 'Create New Rule' }}</h2>
    <form [formGroup]="ruleForm" (ngSubmit)="saveRule()">
      <div class="form-group">
        <label>Name *</label>
        <input type="text" formControlName="name" />
        <small class="error" *ngIf="getFieldError('name')">{{ getFieldError('name') }}</small>
      </div>

      <div class="form-group">
        <label>Selector * (glob or regex:pattern)</label>
        <input type="text" formControlName="selector" placeholder="e.g., src/api/** or regex:^src/.*\\.py$" />
        <small class="error" *ngIf="getFieldError('selector')">{{ getFieldError('selector') }}</small>
        <small class="help-text">Use glob patterns or prefix with "regex:" for regex patterns</small>
      </div>

      <div class="form-group">
        <label>Space Key *</label>
        <input type="text" formControlName="space_key" />
        <small class="error" *ngIf="getFieldError('space_key')">{{ getFieldError('space_key') }}</small>
      </div>

      <div class="form-group">
        <label>Page ID *</label>
        <input type="text" formControlName="page_id" />
        <small class="error" *ngIf="getFieldError('page_id')">{{ getFieldError('page_id') }}</small>
      </div>

      <div class="form-group">
        <label>Template</label>
        <select formControlName="template_id">
          <option [value]="null">None</option>
          <option *ngFor="let template of templates" [value]="template.id">
            {{ template.name }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="auto_approve" />
          Auto-approve patches
        </label>
      </div>

      <div class="form-actions">
        <button type="submit" [disabled]="isSubmitting || ruleForm.invalid" class="btn-primary">
          <span *ngIf="!isSubmitting">{{ editingRule ? 'Update' : 'Create' }}</span>
          <span *ngIf="isSubmitting" class="button-loading">
            <mat-spinner diameter="16" class="inline-spinner"></mat-spinner>
            Saving...
          </span>
        </button>
        <button type="button" (click)="cancelEdit()" [disabled]="isSubmitting" class="btn-secondary">
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Rules List -->
  <div class="rules-list">
    <h2>Existing Rules ({{ rules.length }})</h2>
    
    <div *ngIf="isLoading" class="loading-state" role="status" aria-label="Loading rules">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading rules...</p>
    </div>

    <div *ngIf="!isLoading && rules.length === 0" class="empty-state">
      <p>No rules configured. Create your first rule to get started.</p>
    </div>
    <ng-container *ngIf="!isLoading">
      <div *ngFor="let rule of rules" class="rule-card">
      <div class="rule-header">
        <h3>{{ rule.name }}</h3>
        <div class="rule-actions">
          <button (click)="startEdit(rule)" [disabled]="isDeleting[rule.id]" class="btn-small">Edit</button>
          <button (click)="deleteRule(rule)" [disabled]="isDeleting[rule.id]" class="btn-small btn-danger">
            <span *ngIf="!isDeleting[rule.id]">Delete</span>
            <span *ngIf="isDeleting[rule.id]" class="button-loading">
              <mat-spinner diameter="16" class="inline-spinner"></mat-spinner>
              Deleting...
            </span>
          </button>
        </div>
      </div>
      <div class="rule-details">
        <div><strong>Selector:</strong> {{ rule.selector }}</div>
        <div><strong>Space:</strong> {{ rule.space_key }}</div>
        <div><strong>Page ID:</strong> {{ rule.page_id }}</div>
        <div *ngIf="rule.template_id"><strong>Template ID:</strong> {{ rule.template_id }}</div>
        <div><strong>Auto-approve:</strong> {{ rule.auto_approve ? 'Yes' : 'No' }}</div>
      </div>
    </div>
    </ng-container>
  </div>
</div>

