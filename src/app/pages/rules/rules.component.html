<div class="rules-page">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <div class="page-header">
    <h1>Rules Management</h1>
    <button 
      *ngIf="!editingRule" 
      (click)="startCreate()" 
      class="btn-primary"
      aria-label="Create a new rule"
    >
      Create New Rule
    </button>
  </div>

  <!-- Rule Form -->
  <div *ngIf="editingRule !== null || isCreating" class="rule-form-card" id="main-content">
    <h2>{{ editingRule ? 'Edit Rule' : 'Create New Rule' }}</h2>
    <form [formGroup]="ruleForm" (ngSubmit)="saveRule()" role="form" [attr.aria-label]="editingRule ? 'Edit rule form' : 'Create new rule form'">
      <div class="form-group">
        <label for="rule-name" class="required">Name</label>
        <input 
          id="rule-name"
          type="text" 
          formControlName="name"
          [attr.aria-invalid]="getFieldError('name') ? 'true' : 'false'"
          [attr.aria-describedby]="getFieldError('name') ? 'name-error' : null"
          aria-required="true"
        />
        <small 
          class="error" 
          *ngIf="getFieldError('name')"
          id="name-error"
          role="alert"
          aria-live="polite"
        >
          {{ getFieldError('name') }}
        </small>
      </div>

      <div class="form-group">
        <label for="rule-selector" class="required">Selector (glob or regex:pattern)</label>
        <input 
          id="rule-selector"
          type="text" 
          formControlName="selector" 
          placeholder="e.g., src/api/** or regex:^src/.*\\.py$"
          [attr.aria-invalid]="getFieldError('selector') ? 'true' : 'false'"
          [attr.aria-describedby]="getFieldError('selector') ? 'selector-error selector-help' : 'selector-help'"
          aria-required="true"
        />
        <small 
          class="error" 
          *ngIf="getFieldError('selector')"
          id="selector-error"
          role="alert"
          aria-live="polite"
        >
          {{ getFieldError('selector') }}
        </small>
        <small class="help-text" id="selector-help">Use glob patterns or prefix with "regex:" for regex patterns</small>
      </div>

      <div class="form-group">
        <label for="rule-space-key" class="required">Space Key</label>
        <input 
          id="rule-space-key"
          type="text" 
          formControlName="space_key"
          [attr.aria-invalid]="getFieldError('space_key') ? 'true' : 'false'"
          [attr.aria-describedby]="getFieldError('space_key') ? 'space-key-error' : null"
          aria-required="true"
        />
        <small 
          class="error" 
          *ngIf="getFieldError('space_key')"
          id="space-key-error"
          role="alert"
          aria-live="polite"
        >
          {{ getFieldError('space_key') }}
        </small>
      </div>

      <div class="form-group">
        <label for="rule-page-id" class="required">Page ID</label>
        <input 
          id="rule-page-id"
          type="text" 
          formControlName="page_id"
          [attr.aria-invalid]="getFieldError('page_id') ? 'true' : 'false'"
          [attr.aria-describedby]="getFieldError('page_id') ? 'page-id-error' : null"
          aria-required="true"
        />
        <small 
          class="error" 
          *ngIf="getFieldError('page_id')"
          id="page-id-error"
          role="alert"
          aria-live="polite"
        >
          {{ getFieldError('page_id') }}
        </small>
      </div>

      <div class="form-group">
        <label for="rule-template">Template</label>
        <select 
          id="rule-template"
          formControlName="template_id"
          aria-label="Select a template (optional)"
        >
          <option [value]="null">None</option>
          <option *ngFor="let template of templates" [value]="template.id">
            {{ template.name }}
          </option>
        </select>
      </div>

      <div class="form-group">
        <label for="rule-prompt">LLM Prompt</label>
        <select 
          id="rule-prompt"
          formControlName="prompt_id"
          aria-label="Select an LLM prompt (optional)"
        >
          <option [value]="null">None (No LLM)</option>
          <option *ngFor="let prompt of prompts" [value]="prompt.id">
            {{ prompt.name }}{{ prompt.is_default ? ' (Default)' : '' }}
          </option>
        </select>
        <small class="help-text">Select a prompt to use for LLM summarization, or None to skip LLM processing</small>
      </div>

      <div class="form-group">
        <label for="rule-update-strategy" class="required">Update Strategy</label>
        <select 
          id="rule-update-strategy"
          formControlName="update_strategy"
          aria-label="Select update strategy"
          aria-required="true"
        >
          <option value="replace">Replace - Replace entire page content</option>
          <option value="append">Append - Append new content with separator</option>
          <option value="modify_section">Modify Section - Update specific section by marker</option>
        </select>
        <small class="help-text">
          <strong>Replace:</strong> Completely replaces page content.<br>
          <strong>Append:</strong> Adds new content at the end with a separator.<br>
          <strong>Modify Section:</strong> Updates a specific section identified by XML comment markers.
        </small>
      </div>

      <div class="form-group">
        <label for="rule-auto-approve">
          <input 
            id="rule-auto-approve"
            type="checkbox" 
            formControlName="auto_approve"
            aria-label="Auto-approve patches"
          />
          Auto-approve patches
        </label>
      </div>

      <div class="form-actions">
        <button 
          type="submit" 
          [disabled]="isSubmitting || ruleForm.invalid" 
          class="btn-primary"
          [attr.aria-busy]="isSubmitting"
          [attr.aria-label]="editingRule ? 'Update rule' : 'Create rule'"
        >
          <span *ngIf="!isSubmitting" aria-hidden="false">{{ editingRule ? 'Update' : 'Create' }}</span>
          <span *ngIf="isSubmitting" class="button-loading" aria-hidden="true">
            <mat-spinner diameter="16" class="inline-spinner" aria-hidden="true"></mat-spinner>
            <span class="sr-only">Saving rule, please wait</span>
            Saving...
          </span>
        </button>
        <button 
          type="button" 
          (click)="cancelEdit()" 
          [disabled]="isSubmitting" 
          class="btn-secondary"
          aria-label="Cancel editing rule"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>

  <!-- Rules List -->
  <div class="rules-list" [attr.aria-label]="'Rules list with ' + rules.length + ' rules'">
    <h2>Existing Rules ({{ rules.length }})</h2>
    
    <div *ngIf="isLoading" class="loading-state" role="status" aria-label="Loading rules" aria-live="polite">
      <mat-spinner diameter="40" aria-hidden="true"></mat-spinner>
      <p>Loading rules...</p>
    </div>

    <div *ngIf="!isLoading && rules.length === 0" class="empty-state" role="status" aria-live="polite">
      <p>No rules configured. Create your first rule to get started.</p>
    </div>
    <ng-container *ngIf="!isLoading">
      <div *ngFor="let rule of rules; trackBy: trackByRuleId" class="rule-card" [attr.aria-label]="'Rule: ' + rule.name">
      <div class="rule-header">
        <h3>{{ rule.name }}</h3>
        <div class="rule-actions">
          <button 
            (click)="startEdit(rule)" 
            [disabled]="isDeleting[rule.id]" 
            class="btn-small"
            [attr.aria-label]="'Edit rule ' + rule.name"
          >
            Edit
          </button>
          <button 
            (click)="deleteRule(rule)" 
            [disabled]="isDeleting[rule.id]" 
            class="btn-small btn-danger"
            [attr.aria-busy]="isDeleting[rule.id]"
            [attr.aria-label]="'Delete rule ' + rule.name"
          >
            <span *ngIf="!isDeleting[rule.id]" aria-hidden="false">Delete</span>
            <span *ngIf="isDeleting[rule.id]" class="button-loading" aria-hidden="true">
              <mat-spinner diameter="16" class="inline-spinner" aria-hidden="true"></mat-spinner>
              <span class="sr-only">Deleting rule, please wait</span>
              Deleting...
            </span>
          </button>
        </div>
      </div>
      <div class="rule-details">
        <div><strong>Selector:</strong> {{ rule.selector }}</div>
        <div><strong>Space:</strong> {{ rule.space_key }}</div>
        <div><strong>Page ID:</strong> {{ rule.page_id }}</div>
        <div *ngIf="rule.template_id"><strong>Template ID:</strong> {{ rule.template_id }}</div>
        <div><strong>LLM Prompt:</strong> {{ getPromptName(rule.prompt_id) }}</div>
        <div><strong>Update Strategy:</strong> {{ rule.update_strategy || 'replace' }}</div>
        <div><strong>Auto-approve:</strong> {{ rule.auto_approve ? 'Yes' : 'No' }}</div>
      </div>
    </div>
    </ng-container>
  </div>
</div>

